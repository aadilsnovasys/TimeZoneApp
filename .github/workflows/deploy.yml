name: Deploy TimeZoneApp to IIS

on:
  workflow_run:
    workflows: ["Build TimeZoneApp"]  # Triggered by the successful completion of the build workflow
    types:
      - completed

jobs:
  deploy:
    runs-on: self-hosted  # Your self-hosted runner for deployment

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Download build artifact
      uses: actions/download-artifact@v3
      with:
        name: TimeZoneApp  # Download the artifact from the build workflow
        path: ./publish

    - name: Stop IIS Site
      run: |
        Import-Module WebAdministration
        Stop-WebAppPool -Name "TimeZoneApp"
        Stop-Website -Name "TimeZoneApp"
      shell: pwsh

    - name: Deploy to IIS
      run: |
        $iisPath = "C:\web\TimeZoneApp"
        Remove-Item -Recurse -Force -Path $iisPath\*
        Copy-Item -Path ./publish/* -Destination $iisPath -Recurse
      shell: pwsh

    - name: Start IIS Site
      run: |
        Import-Module WebAdministration
        Start-WebAppPool -Name "TimeZoneApp"
        Start-Website -Name "TimeZoneApp"
      shell: pwsh
