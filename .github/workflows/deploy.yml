name: Deploy to IIS

on:
  push:
    branches:
      - master  # Deploy when changes are pushed to the master branch

jobs:
  deploy:
    runs-on: self-hosted  # Windows runner

    steps:
      # Step 1: Check out the code
      - name: Checkout Code
        uses: actions/checkout@v3

      # Step 2: Build and Publish the app
      - name: Build and Publish
        run: |
          dotnet publish -c Release -o published

      # Step 3: Deploy using PowerShell (for Windows)
      - name: Deploy to IIS (PowerShell)
        shell: pwsh
        run: |
          $session = New-PSSession -ComputerName $env:SERVER_HOST -Credential (New-Object System.Management.Automation.PSCredential($env:SERVER_USER, (ConvertTo-SecureString $env:SERVER_PASSWORD -AsPlainText -Force)))
          Invoke-Command -Session $session -ScriptBlock {
              # Backup the existing app
              New-Item -Path "C:\inetpub\TimeZoneApp\backup" -ItemType Directory -Force
              Move-Item -Path "C:\inetpub\TimeZoneApp\*" -Destination "C:\inetpub\TimeZoneApp\backup" -Force

              # Copy the published files
              robocopy "C:\actions-runner\_work\TimeZoneApp\published" "C:\inetpub\TimeZoneApp" /mir

              # Restart IIS (optional)
              iisreset
          }
          Remove-PSSession -Session $session
